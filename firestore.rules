rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Function to check if the user is logged in
    function isLoggedIn() {
      return request.auth != null;
    }

    // Function to check if the user is an admin
    function isAdmin() {
      return request.auth != null && request.auth.token.company == '9eaXpBDG4FVfJHkAHK5d';
    }

    // Function to check if the user belongs to a company
    function isCompany(company) {
      return request.auth != null && request.auth.token.company == company;
    }

    // Reusable function for general read and write permissions
    function canReadWrite() {
      return isLoggedIn() || isAdmin();
    }

    match /company/{id} {
      allow read, write: if canReadWrite();
      allow delete: if false;  // Disallow deletion of companies

      // Nested collections within company

      match /adjustments/{id} {
        allow read, write: if canReadWrite();
      }

      match /billableShipments/{id} {
        allow read, write: if canReadWrite();
      }

      match /brokers/{id} {
        allow read, write: if canReadWrite();
      }

      match /bulkEstimates/{id} {
        allow read, write: if canReadWrite();
      }

      match /bulkUpdates/{id} {
        allow read, write: if canReadWrite();
      }

      match /creditApplications/{id} {
        allow read, write: if true;
      }

      match /credits/{id} {
        allow read, write: if canReadWrite();
      }

      match /customers/{id} {
        allow read, write: if canReadWrite();
      }

      match /dismantles/{id} {
        allow read, write: if canReadWrite();
        allow update: if true;
      }

      match /enquiries/{id} {
        allow read, write: if canReadWrite();
      }

      match /estimates/{id} {
        allow read, write: if canReadWrite();
      }

      match /areaEstimates/{id} {
        allow read,write: if true;
      }

      match /estimatesV2/{id} {
        allow read, write: if canReadWrite();
      }

      match /handovers/{id} {
        allow read, write: if canReadWrite();
        allow update: if true;
      }

       match /jobs/{id} {
        allow read, write: if canReadWrite();
      }

      match /jsp/{id} {
        allow read, write: if canReadWrite();
      }

      match /flha/{id} {
        allow read, write: if canReadWrite();
      }

      match /inspections/{id} {
        allow read, write: if canReadWrite();
      }

      match /inventoryEstimates/{id} {
        allow read, write: if canReadWrite();
      }

      match /inventoryEstimatesSell/{id} {
        allow read, write: if canReadWrite();
      }

      match /inventoryEstimatesRent/{id} {
        allow read, write: if canReadWrite();
      }

      match /invoices/{id} {
        allow read, write: if canReadWrite();
      }

      match /modifications/{id} {
        allow read, write: if canReadWrite();
      }

      match /notifications/{id} {
        allow read, write: if canReadWrite();
      }

      match /operationApplications/{id} {
        allow read, write: if canReadWrite();
      }

      match /payments/{id} {
        allow read, write: if canReadWrite();
      }

      match /paymentApplications/{id} {
        allow read, write: if canReadWrite();
      }

      match /overReturns/{id} {
        allow read, write: if canReadWrite();
      }

      match /pos/{id} {
        allow read, write: if canReadWrite();
      }

      match /rateProfiles/{id} {
        allow read, write: if canReadWrite();
      }

      match /requests/{id} {
        allow read, write: if canReadWrite();
      }

      match /returns/{id} {
        allow read, write: if canReadWrite();
      }

      match /saleInvoices/{id} {
        allow read, write: if canReadWrite();
      }


      match /scaffolds/{id} {
        allow read: if true;  // Public access for reading
        allow write: if canReadWrite();
      }

      match /shipments/{id} {
        allow read, write: if canReadWrite();
      }

      match /siteInstructions/{id} {
        allow read, write: if canReadWrite();
      }

      match /siteMovements/{id} {
        allow read, write: if canReadWrite();
      }

      match /siteStock/{id} {
        allow read, write: if canReadWrite();
      }

      match /sites/{id} {
        allow read, write: if canReadWrite();
        match /chat/{id} {
        	allow read, write: if canReadWrite();
      	}
      }

      match /stockItems/{id} {
        allow read, write: if canReadWrite();
         match /log/{id} {
        	allow read, write: if canReadWrite();
      	}
      }

      match /tasks/{id} {
        allow read, write: if canReadWrite();
      }

      match /templates/{id} {
        allow read, write: if canReadWrite();
      }

      match /terms/{id} {
        allow read: if true;
        allow write: if canReadWrite();
      }

      match /timesheets/{id} {
        allow read, write: if canReadWrite();
      }

      match /transactionInvoices/{id} {
        allow read, write: if canReadWrite();
      }

      match /transactionLog/{id} {
        allow read, write: if canReadWrite();
      }

      match /transfers/{id} {
        allow read, write: if canReadWrite();
      }

      match /yardTransfers/{id} {
        allow read, write: if canReadWrite();
      }

      match /poTransfers/{id} {
        allow read, write: if canReadWrite();
      }

      match /transport/{id} {
        allow read, write: if canReadWrite();
      }

      match /userInvitations/{id} {
        allow read, write: if canReadWrite();
      }
    }

    // Global userInvitations collection for SSO invitation checking
    match /userInvitations/{id} {
      allow read: if request.auth != null &&
        (request.auth.token.email == resource.data.email ||
         request.auth.token.company == resource.data.company);
      allow write: if canReadWrite();
    }

    match /mail/{id} {
      allow write: if true;  // Public write access
    }


  // Public access for shared documents

    match /sharedBulkEstimates/{id} {
      allow read, write: if true;
    }

    match /sharedEstimates/{id} {
      allow read, write: if true;
    }

    match /sharedDismantles/{id} {
      allow read, write: if true;
    }

    match /sharedAreaEstimates/{id} {
      allow read, write: if true;
    }

    match /sharedHandovers/{id} {
      allow read, write: if true;
    }

    match /sharedInspections/{id} {
      allow read, write: if true;
    }

    match /users/{uid} {
      allow read: if isLoggedIn();
      allow write: if (request.auth.uid == uid && isLoggedIn()) || isAdmin() || isCompany(resource.data.company);

      match /notifications/{id} {
        allow read, write: if request.auth.uid == uid;
      }
    }

    match /version/{id} {
      allow read: if true;  // Public access for versioning
      allow write: if canReadWrite();
    }

    // Catch-all deny for any document not explicitly matched
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
