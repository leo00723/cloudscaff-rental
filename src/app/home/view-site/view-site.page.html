<ng-container *ngIf="site$ |async as site">
  <app-header
    title="{{site.code}} - {{site.name}}"
    [showMenu]="false"
    [showBack]="true"
    path="/dashboard/sites"
    iconName="settings-outline"
    iconColor="primary"
    (updatedIcon)="editSite(site)"
  >
    <ng-container *ngIf="company$ |async as company">
      <ion-toolbar *ngIf="user$ |async as user">
        <ion-segment
          [scrollable]="true"
          (ionChange)="segmentChanged($event)"
          selectOnFocus="true"
          [value]="active"
          mode="md"
        >
          <ion-segment-button value="scaffolds">
            <ion-label>Scaffolds</ion-label>
          </ion-segment-button>
          <ion-segment-button value="register">
            <ion-label>Scaffold Register</ion-label>
          </ion-segment-button>
          <ion-segment-button value="inventory">
            <ion-label>Inventory</ion-label>
          </ion-segment-button>
          <ion-segment-button
            value="requests"
            *ngIf="user.permissionsList.includes('Site Requests') || user.permissionsList.includes('Super Admin') || user.role === 'Owner'"
          >
            <ion-label>Requests</ion-label>
          </ion-segment-button>
          <ion-segment-button
            value="deliveries"
            *ngIf="user.permissionsList.includes('Site Deliveries') || user.permissionsList.includes('Super Admin') || user.role === 'Owner'"
          >
            <ion-label
              >Deliveries
              <ng-container *ngIf="outboundDeliveries$ | async as deliveries">
                <ion-badge
                  shape="round"
                  mode="ios"
                  color="warning"
                  *ngIf="deliveries.length > 0"
                >
                  {{deliveries.length}}
                </ion-badge>
              </ng-container></ion-label
            >
          </ion-segment-button>
          <ion-segment-button
            value="adjustments"
            *ngIf="user.permissionsList.includes('Site Adjustments') || user.permissionsList.includes('Super Admin') || user.role === 'Owner'"
          >
            <ion-label
              >Adjustments
              <ng-container *ngIf="pendingAdjustments$ | async as adjustments">
                <ion-badge
                  shape="round"
                  mode="ios"
                  color="warning"
                  *ngIf="adjustments.length > 0"
                >
                  {{adjustments.length}}
                </ion-badge>
              </ng-container></ion-label
            >
          </ion-segment-button>
          <ion-segment-button
            value="returns"
            *ngIf="user.permissionsList.includes('Site Returns') || user.permissionsList.includes('Super Admin') || user.role === 'Owner'"
          >
            <ion-label
              >Returns
              <ng-container *ngIf="outboundReturns$ | async as returns">
                <ion-badge
                  shape="round"
                  mode="ios"
                  color="warning"
                  *ngIf="returns.length > 0"
                >
                  {{returns.length}}
                </ion-badge>
              </ng-container></ion-label
            >
          </ion-segment-button>
          <ion-segment-button
            value="SI"
            *ngIf="user.permissionsList.includes('Site Instructions') || user.permissionsList.includes('Super Admin') || user.role === 'Owner'"
          >
            <ion-label
              >Site Instructions
              <ng-container
                *ngIf="pendingInstructions$ | async as instructions"
              >
                <ion-badge
                  shape="round"
                  mode="ios"
                  color="danger"
                  *ngIf="instructions.length > 0"
                >
                  {{instructions.length}}
                </ion-badge>
              </ng-container></ion-label
            >
          </ion-segment-button>
          <ion-segment-button
            value="JobReferenceS"
            *ngIf="user.permissionsList.includes('Job References') || user.permissionsList.includes('Super Admin') || user.role === 'Owner'"
          >
            <ion-label
              >Job References
              <ng-container *ngIf="purchaseOrders$ | async as pos">
                <ion-badge
                  shape="round"
                  mode="ios"
                  color="danger"
                  *ngIf="pos.length > 0"
                >
                  {{pos.length}}
                </ion-badge>
              </ng-container>
            </ion-label>
          </ion-segment-button>
          <ion-segment-button
            value="invoices"
            *ngIf="user.permissionsList.includes('Site Invoices') || user.permissionsList.includes('Super Admin') || user.role === 'Owner'"
          >
            <ion-label
              >Invoices
              <ng-container *ngIf="transactionInvoices$ | async as invoices">
                <ion-badge
                  shape="round"
                  mode="ios"
                  color="danger"
                  *ngIf="invoices.length > 0"
                >
                  {{invoices.length}}
                </ion-badge>
              </ng-container>
            </ion-label>
          </ion-segment-button>
          <ion-segment-button
            value="uploads"
            *ngIf="user.role !== 'Supervisor'"
          >
            <ion-label>Uploads</ion-label>
          </ion-segment-button>
        </ion-segment>
      </ion-toolbar>
    </ng-container>
  </app-header>

  <ion-content fullscreen="true" class="ion-padding">
    <ng-container [ngSwitch]="active">
      <ng-container *ngSwitchDefault>
        <ion-item class="text-end" lines="none">
          <ion-badge slot="end" color="primary" mode="ios">Pending</ion-badge>
          <ion-badge slot="end" color="danger" mode="ios"
            >Not safe for use</ion-badge
          >
          <ion-badge slot="end" color="success" mode="ios"
            >Safe for use</ion-badge
          >
        </ion-item>
        <ion-accordion-group
          mode="ios"
          class="rounded-lg overflow-hidden"
          [multiple]="false"
          [value]="['pending']"
        >
          <ion-accordion
            value="pending"
            *ngIf="pendingScaffolds$ | async as pendingScaffolds else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="primary"
                >Pending Scaffolds ({{pendingScaffolds.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-scaffold-table
                [value]="pendingScaffolds$"
                [showScaffoldList]="true"
                *ngIf="pendingScaffolds$ | async else loading"
                (selectedItem)="viewScaffold($event)"
              ></app-scaffold-table>
            </div>
          </ion-accordion>
          <ion-accordion
            value="inactive"
            *ngIf="inactiveScaffolds$ | async as inactiveScaffolds else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="warning"
                >Inactive Scaffolds ({{inactiveScaffolds.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-scaffold-table
                [value]="inactiveScaffolds$"
                [showScaffoldList]="true"
                *ngIf="inactiveScaffolds$ | async else loading"
                (selectedItem)="viewScaffold($event)"
              ></app-scaffold-table>
            </div>
          </ion-accordion>
          <ion-accordion
            value="active"
            *ngIf="erectedScaffolds$ | async as erectedScaffolds else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="success"
                >Erected Scaffolds ({{erectedScaffolds.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-scaffold-table
                [value]="erectedScaffolds$"
                [showScaffoldList]="true"
                *ngIf="erectedScaffolds$ | async else loading"
                (selectedItem)="viewScaffold($event)"
              ></app-scaffold-table>
            </div>
          </ion-accordion>
          <ion-accordion
            value="dismantled"
            *ngIf="dismantledScaffolds$ | async as dismantledScaffolds else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="danger"
                >Dismantled Scaffolds
                ({{dismantledScaffolds.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-scaffold-table
                [value]="dismantledScaffolds$"
                [showScaffoldList]="true"
                *ngIf="dismantledScaffolds$ | async else loading"
                (selectedItem)="viewScaffold($event)"
              ></app-scaffold-table>
            </div>
          </ion-accordion>
        </ion-accordion-group>

        <ion-fab
          class="m-2"
          vertical="bottom"
          horizontal="end"
          slot="fixed"
          *ngIf="site.status !== 'closed'"
        >
          <ion-fab-button (click)="addScaffold(site)">
            <ion-icon name="add"></ion-icon>
          </ion-fab-button>
        </ion-fab>
      </ng-container>
      <ng-container *ngSwitchCase="'register'">
        <ng-container *ngIf="company$ | async as company">
          <div class="qrcodeImage" [hidden]="true">
            <!-- [imageSrc]="company?.replaceBranding || 'assets/logos/logo.svg'" -->
            <qrcode
              #QRCODE
              [qrdata]="'https://app.cloudscaff.com/viewRegister/'+ids[0]+'-'+ids[1]"
              [imageHeight]="75"
              [imageWidth]="75"
              title="SCAFFOLD_REGISTER_{{site.name}}_{{site.code}}"
              [allowEmptyString]="false"
              [elementType]="'canvas'"
              [errorCorrectionLevel]="'H'"
              [margin]="4"
              [scale]="1"
              [width]="300"
            ></qrcode>
          </div>
          <div class="text-end">
            <ion-button
              mode="ios"
              fill="outline"
              size="small"
              shape="round"
              color="tertiary"
              (click)="saveAsImage(QRCODE,site.name+'-'+site.code+'.png')"
            >
              Download QR
              <ion-icon slot="end" name="qr-code-outline"></ion-icon>
            </ion-button></div
        ></ng-container>
        <ion-accordion-group
          mode="ios"
          class="rounded-lg overflow-hidden"
          [multiple]="false"
          [value]="['active']"
        >
          <ion-accordion
            value="active"
            *ngIf="activeScaffolds$ | async as activeScaffolds else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="success"
                >Active Scaffolds ({{activeScaffolds.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-scaffold-table
                [value]="activeScaffolds$"
                [showRegister]="true"
                [allowInspection]="true"
                *ngIf="activeScaffolds$ | async else loading"
                (selectedItem)="viewScaffold($event)"
              ></app-scaffold-table>
            </div>
          </ion-accordion>
          <ion-accordion
            value="dismantled"
            *ngIf="dismantledScaffolds$ | async as dismantledScaffolds else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="danger"
                >Dismantled Scaffolds
                ({{dismantledScaffolds.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-scaffold-table
                [value]="dismantledScaffolds$"
                [showRegister]="true"
                *ngIf="dismantledScaffolds$ | async else loading"
                (selectedItem)="viewScaffold($event)"
              ></app-scaffold-table>
            </div>
          </ion-accordion>
        </ion-accordion-group>
      </ng-container>
      <ng-container *ngSwitchCase="'inventory'">
        <app-site-inventory-table
          [value]="{items:items.items,ids}"
          (download)="downloadPDF($event, site)"
          (downloadHistoryExcel)="downloadHistoryExcel(site)"
          *ngIf="inventoryItems$ | async as items else empty"
        ></app-site-inventory-table>
        <ng-template #empty>
          <app-site-inventory-table
            [value]="{items:[],ids:[]}"
            (download)="downloadPDF($event, site)"
            (downloadHistoryExcel)="downloadHistoryExcel(site)"
          ></app-site-inventory-table>
        </ng-template>
      </ng-container>
      <ng-container *ngSwitchCase="'requests'">
        <ion-accordion-group
          mode="ios"
          class="rounded-lg overflow-hidden"
          [multiple]="true"
          [value]="['pending']"
        >
          <ng-container *ngIf="pendingRequests$ | async as pr else loading">
            <ion-accordion value="pending">
              <ion-item slot="header" color="light">
                <ion-label color="primary"
                  >Pending Requests ({{pr.length}})</ion-label
                >
              </ion-item>
              <div class="ion-padding" slot="content">
                <app-requests-table
                  [value]="pendingRequests$"
                  (selectedItem)="viewRequest($event,site)"
                ></app-requests-table>
              </div>
            </ion-accordion>
          </ng-container>
          <ng-container *ngIf="submittedRequests$ | async as sr else loading">
            <ion-accordion value="submitted">
              <ion-item slot="header" color="light">
                <ion-label color="warning"
                  >Submitted Requests ({{sr.length}})</ion-label
                >
              </ion-item>
              <div class="ion-padding" slot="content">
                <app-requests-table
                  [value]="submittedRequests$"
                  (selectedItem)="viewRequest($event,site)"
                ></app-requests-table>
              </div>
            </ion-accordion>
          </ng-container>
          <ng-container *ngIf="approvedRequests$ | async as r else loading">
            <ion-accordion value="approved">
              <ion-item slot="header" color="light">
                <ion-label color="success"
                  >Approved Requests ({{r.length}})</ion-label
                >
              </ion-item>
              <div class="ion-padding" slot="content">
                <app-requests-table
                  [value]="approvedRequests$"
                  (selectedItem)="viewRequest($event,site)"
                ></app-requests-table>
              </div>
            </ion-accordion>
          </ng-container>
        </ion-accordion-group>

        <ion-fab
          class="m-2"
          vertical="bottom"
          horizontal="end"
          slot="fixed"
          *ngIf="site.status !== 'closed'"
        >
          <ion-fab-button (click)="addRequest(site)">
            <ion-icon name="add"></ion-icon>
          </ion-fab-button>
        </ion-fab>
      </ng-container>
      <ng-container *ngSwitchCase="'deliveries'">
        <ion-accordion-group
          mode="ios"
          class="rounded-lg overflow-hidden mb-5"
          [multiple]="true"
          [value]="['outbound']"
        >
          <ng-container *ngIf="outboundDeliveries$ | async as os else loading">
            <ion-accordion value="outbound">
              <ion-item slot="header" color="light">
                <ion-label color="warning"
                  >Outbound Deliveries ({{os.length}})</ion-label
                >
              </ion-item>
              <div class="ion-padding" slot="content">
                <app-delivery-table
                  [value]="outboundDeliveries$"
                  (selectedItem)="viewShipment($event)"
                ></app-delivery-table>
              </div>
            </ion-accordion>
          </ng-container>

          <ng-container *ngIf="deliveries$ | async as d else loading">
            <ion-accordion value="completed">
              <ion-item slot="header" color="light">
                <ion-label color="success"
                  >Completed Deliveries ({{d.length}})</ion-label
                >
              </ion-item>
              <div class="ion-padding" slot="content">
                <app-delivery-table
                  [value]="deliveries$"
                  (selectedItem)="viewShipment($event)"
                ></app-delivery-table>
              </div>
            </ion-accordion>
          </ng-container>
        </ion-accordion-group>
      </ng-container>
      <ng-container *ngSwitchCase="'adjustments'">
        <ion-accordion-group
          mode="ios"
          class="rounded-lg overflow-hidden"
          [multiple]="true"
          [value]="['pending','outbound']"
        >
          <ng-container
            *ngIf="pendingAdjustments$ | async as pAdj else loading"
          >
            <ion-accordion value="pending">
              <ion-item slot="header" color="light">
                <ion-label color="primary"
                  >Pending Adjustments ({{pAdj.length}})</ion-label
                >
              </ion-item>
              <div class="ion-padding" slot="content">
                <app-returns-table
                  [value]="pendingAdjustments$"
                  (selectedItem)="viewAdjustment($event,site)"
                ></app-returns-table>
              </div>
            </ion-accordion>
          </ng-container>

          <ng-container *ngIf="adjustments$ | async as adj else loading">
            <ion-accordion value="approved">
              <ion-item slot="header" color="light">
                <ion-label color="success"
                  >Completed Adjustments ({{adj.length}})</ion-label
                >
              </ion-item>
              <div class="ion-padding" slot="content">
                <app-returns-table
                  [value]="adjustments$"
                  (selectedItem)="viewAdjustment($event,site)"
                ></app-returns-table>
              </div>
            </ion-accordion>
          </ng-container>
        </ion-accordion-group>

        <ion-fab
          class="m-2"
          vertical="bottom"
          horizontal="end"
          slot="fixed"
          *ngIf="site.status !== 'closed'"
        >
          <ion-fab-button (click)="addAdjustment(site)">
            <ion-icon name="add"></ion-icon>
          </ion-fab-button>
        </ion-fab>
      </ng-container>
      <ng-container *ngSwitchCase="'returns'">
        <ion-accordion-group
          mode="ios"
          class="rounded-lg overflow-hidden"
          [multiple]="true"
          [value]="['pending','outbound']"
        >
          <ng-container *ngIf="pendingReturns$ | async as pr else loading">
            <ion-accordion value="pending">
              <ion-item slot="header" color="light">
                <ion-label color="primary"
                  >Pending Returns ({{pr.length}})</ion-label
                >
              </ion-item>
              <div class="ion-padding" slot="content">
                <app-returns-table
                  [value]="pendingReturns$"
                  (selectedItem)="viewReturn($event,site)"
                ></app-returns-table>
              </div>
            </ion-accordion>
          </ng-container>
          <ng-container *ngIf="outboundReturns$ | async as or else loading">
            <ion-accordion value="outbound">
              <ion-item slot="header" color="light">
                <ion-label color="warning"
                  >Outbound Returns ({{or.length}})</ion-label
                >
              </ion-item>
              <div class="ion-padding" slot="content">
                <app-returns-table
                  [value]="outboundReturns$"
                  (selectedItem)="viewReturn($event,site)"
                ></app-returns-table>
              </div>
            </ion-accordion>
          </ng-container>
          <ng-container *ngIf="returns$ | async as r else loading">
            <ion-accordion value="approved">
              <ion-item slot="header" color="light">
                <ion-label color="success"
                  >Completed Returns ({{r.length}})</ion-label
                >
              </ion-item>
              <div class="ion-padding" slot="content">
                <app-returns-table
                  [allowReports]="true"
                  [value]="returns$"
                  (selectedItem)="viewReturn($event,site)"
                ></app-returns-table>
              </div>
            </ion-accordion>
          </ng-container>
        </ion-accordion-group>

        <ion-fab
          class="m-2"
          vertical="bottom"
          horizontal="end"
          slot="fixed"
          *ngIf="site.status !== 'closed'"
        >
          <ion-fab-button (click)="addReturn(site)">
            <ion-icon name="add"></ion-icon>
          </ion-fab-button>
        </ion-fab>
      </ng-container>
      <ng-container *ngSwitchCase="'SI'">
        <ion-accordion-group
          mode="ios"
          class="rounded-lg overflow-hidden mb-5"
          [multiple]="true"
          [value]="['pending']"
        >
          <ion-accordion
            value="pending"
            *ngIf="pendingInstructions$ | async as pis else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="primary"
                >Pending Instructions ({{pis.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-si-table
                [value]="pendingInstructions$"
                (selectedItem)="viewInstruction($event,site)"
              ></app-si-table>
            </div>
          </ion-accordion>
          <ion-accordion
            value="signed"
            *ngIf="signedInstructions$ | async as sis else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="warning"
                >Signed Instructions ({{sis.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-si-table
                [value]="signedInstructions$"
                (selectedItem)="viewInstruction($event,site)"
              ></app-si-table>
            </div>
          </ion-accordion>
          <ion-accordion
            value="completed"
            *ngIf="instructions$ | async as cis else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="success"
                >Completed Instructions ({{cis.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-si-table
                [value]="instructions$"
                (selectedItem)="viewInstruction($event,site)"
              ></app-si-table>
            </div>
          </ion-accordion>
        </ion-accordion-group>
        <ion-fab
          class="m-2"
          vertical="bottom"
          horizontal="end"
          slot="fixed"
          *ngIf="site.status !== 'closed'"
        >
          <ion-fab-button (click)="addInstruction(site)">
            <ion-icon name="add"></ion-icon>
          </ion-fab-button>
        </ion-fab>
      </ng-container>
      <ng-container *ngSwitchCase="'JobReferenceS'">
        <ion-accordion-group
          mode="ios"
          class="rounded-lg overflow-hidden mb-5"
          [multiple]="true"
          [value]="['pending']"
        >
          <ion-accordion
            value="pending"
            *ngIf="purchaseOrders$ | async as pos else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="primary"
                >Pending Job Reference's ({{pos.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-job-reference-table
                [value]="purchaseOrders$"
                (selectedItem)="viewJobReference($event,site)"
              ></app-job-reference-table>
            </div>
          </ion-accordion>
          <ion-accordion
            value="completed"
            *ngIf="completedJobReference$ | async as cpos else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="success"
                >Completed Job Reference's ({{cpos.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-job-reference-table
                [value]="completedJobReference$"
                (selectedItem)="viewJobReference($event,site)"
              ></app-job-reference-table>
            </div>
          </ion-accordion>
        </ion-accordion-group>

        <ion-fab
          class="m-2"
          vertical="bottom"
          horizontal="end"
          slot="fixed"
          *ngIf="site.status !== 'closed'"
        >
          <ion-fab-button (click)="addJobReference(site)">
            <ion-icon name="add"></ion-icon>
          </ion-fab-button>
        </ion-fab>
      </ng-container>
      <ng-container *ngSwitchCase="'invoices'">
        <ion-accordion-group
          mode="ios"
          class="rounded-lg overflow-hidden mb-5"
          [multiple]="true"
          [value]="['pending']"
        >
          <ion-accordion
            value="pending"
            *ngIf="transactionInvoices$ | async as invoices else loading"
          >
            <ion-item slot="header" color="light">
              <ion-label color="success"
                >Invoices ({{invoices.length}})</ion-label
              >
            </ion-item>
            <div class="ion-padding" slot="content">
              <app-job-reference-table
                [value]="transactionInvoices$"
                (selectedItem)="viewInvoice($event)"
              ></app-job-reference-table>
            </div>
          </ion-accordion>
        </ion-accordion-group>
      </ng-container>
      <ng-container *ngSwitchCase="'uploads'">
        <ion-row>
          <ion-col size="12">
            <app-multiuploader
              [autoupload]="true"
              (uploaded)="setUploads($event,site)"
            ></app-multiuploader>
          </ion-col>
          <ion-col size="12">
            <app-title-block> Uploaded Files </app-title-block>
            <ion-row>
              <ion-col
                size="12"
                *ngFor="let file of site.uploads; let i = index"
              >
                <app-file-item
                  [simplified]="true"
                  [file]="file"
                  [allowDelete]="true"
                  (deleted)="removeUpload(i,site)"
                ></app-file-item>
              </ion-col>
            </ion-row>
          </ion-col>
        </ion-row>
      </ng-container>
      <ng-template #loading>
        <div class="ion-padding">
          <app-skeleton-text></app-skeleton-text>
          <app-skeleton-text></app-skeleton-text>
          <app-skeleton-text></app-skeleton-text>
          <app-skeleton-text></app-skeleton-text>
        </div>
      </ng-template>
    </ng-container>
  </ion-content>
</ng-container>
