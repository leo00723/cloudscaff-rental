<ng-container *ngIf="isMobile; else desktop">
  <!-- Mobile Header -->
  <ion-header mode="md">
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button (click)="close()">
          <ion-icon
            slot="icon-only"
            name="arrow-back-outline"
            color="primary"
          ></ion-icon>
        </ion-button>
      </ion-buttons>
      <ion-title>
        {{ !isEdit ? "Add Delivery" : "Edit Delivery" }}
        <ion-text *ngIf="loading"
          ><i class="text-muted fs-6">(Saving...)</i></ion-text
        >
      </ion-title>
      <ion-buttons slot="end">
        <ng-container *ngTemplateOutlet="headerActions"></ng-container>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>

  <!-- Mobile Content -->
  <ion-content class="ion-padding">
    <form [formGroup]="form" *ngIf="form">
      <ion-grid>
        <ng-container *ngTemplateOutlet="siteInformation"></ng-container>
        <ng-container
          *ngTemplateOutlet="contactInformation; context: { isMobile: true }"
        ></ng-container>
        <ng-container *ngTemplateOutlet="deliveryInformation"></ng-container>
        <ng-container
          *ngTemplateOutlet="inventorySection; context: { isMobile: true }"
        ></ng-container>
        <ng-container
          *ngTemplateOutlet="uploadsSection; context: { isMobile: true }"
        ></ng-container>
        <ng-container *ngTemplateOutlet="signaturesSection"></ng-container>
        <ng-container *ngTemplateOutlet="signaturePad"></ng-container>
      </ion-grid>
    </form>
  </ion-content>

  <!-- Mobile Footer -->
  <ng-container *ngTemplateOutlet="footer"></ng-container>
</ng-container>

<!-- Desktop Template -->
<ng-template #desktop>
  <form [formGroup]="form" *ngIf="form">
    <ion-split-pane when="xs" contentId="delivery">
      <!-- Desktop Menu -->
      <ion-menu contentId="delivery" menuId="delivery">
        <ion-header mode="md">
          <ion-toolbar>
            <ion-buttons slot="start">
              <ion-button (click)="close()">
                <ion-icon
                  slot="icon-only"
                  name="arrow-back-outline"
                  color="primary"
                ></ion-icon>
              </ion-button>
            </ion-buttons>
            <ion-title>
              {{ !isEdit ? "Add Delivery" : "Edit Delivery" }}
              <ion-text *ngIf="loading"
                ><i class="text-muted fs-6">(Saving...)</i></ion-text
              >
            </ion-title>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
          <ion-row>
            <ng-container *ngTemplateOutlet="siteInformation"></ng-container>
            <ng-container
              *ngTemplateOutlet="
                contactInformation;
                context: { isMobile: false }
              "
            ></ng-container>
            <ng-container
              *ngTemplateOutlet="deliveryInformation"
            ></ng-container>
            <ng-container
              *ngTemplateOutlet="uploadsSection; context: { isMobile: false }"
            ></ng-container>
            <ng-container *ngTemplateOutlet="signaturesSection"></ng-container>
            <ng-container *ngTemplateOutlet="signaturePad"></ng-container>
          </ion-row>
        </ion-content>
      </ion-menu>

      <!-- Desktop Main Content -->
      <div class="ion-page" id="delivery">
        <ion-header mode="md">
          <ion-toolbar>
            <ion-buttons slot="end">
              <ng-container *ngTemplateOutlet="headerActions"></ng-container>
            </ion-buttons>
          </ion-toolbar>
          <ion-item lines="none">
            <ion-searchbar
              class="p-0 m-0"
              debounce="250"
              mode="ios"
              placeholder="Search by code, category or name"
              (ionChange)="search($event)"
            >
            </ion-searchbar>
            <ion-label slot="end">Show all Items</ion-label>
            <ion-toggle
              slot="end"
              [checked]="viewAll === true || searching === true ? true : false"
              (ionChange)="viewAll = !viewAll"
            >
            </ion-toggle>
          </ion-item>
        </ion-header>
        <ion-content class="ion-padding">
          <ng-container
            *ngTemplateOutlet="inventorySection; context: { isMobile: false }"
          ></ng-container>
        </ion-content>
        <ng-container *ngTemplateOutlet="footer"></ng-container>
      </div>
    </ion-split-pane>
  </form>
</ng-template>

<!-- Shared Templates -->

<!-- Header Actions Template -->
<ng-template #headerActions>
  <ng-container *ngIf="!uploading && shipment.status === 'pending'">
    <ion-chip
      (click)="fileInput.click()"
      mode="ios"
      shape="round"
      size="small"
      color="success"
    >
      Import List
    </ion-chip>
    <input
      style="display: none"
      type="file"
      accept=".csv"
      (change)="onFileChanged($event)"
      #fileInput
    />
  </ng-container>
  <ng-container *ngIf="isEdit">
    <ion-chip
      (click)="downloadPicklist()"
      mode="ios"
      shape="round"
      size="small"
      color="primary"
    >
      Picklist
    </ion-chip>
    <ion-chip
      (click)="downloadPdf()"
      mode="ios"
      shape="round"
      size="small"
      color="tertiary"
    >
      Delivery Note
    </ion-chip>
  </ng-container>
</ng-template>

<!-- Site Information Template -->
<ng-template #siteInformation>
  <ion-col size="12">
    <app-title-block>Site Information</app-title-block>
  </ion-col>
  <ion-col size="12" *ngIf="shipment.status === 'pending'">
    <ng-container *ngIf="sites$ | async as sites">
      <app-searchable-select
        (click)="select.open()"
        title="Select Site"
        [data]="sites"
        itemTextField="name"
        itemTextField2="customer.name"
        itemTextField3="code"
        [add]="false"
        (selectedChanged)="changeSite($event)"
        #select
      >
      </app-searchable-select>
    </ng-container>
  </ion-col>
  <ion-col *ngIf="field('site').value as site">
    <app-input-text
      title="Site Address"
      [value]="site.name"
      [readonly]="true"
    ></app-input-text>
    <app-input-text
      title="Site Code"
      [value]="site.code"
      [readonly]="true"
    ></app-input-text>
    <app-input-text
      title="Customer Name"
      [value]="site.customer.name"
      [readonly]="true"
    ></app-input-text>
    <app-input-text
      title="Site Address"
      value="{{ site.address }} , {{ site.suburb }} , {{ site.city }}, {{
        site.zip
      }}, {{ site.country }}"
      [readonly]="true"
    >
    </app-input-text>
    <app-input-select-reactive
      title="Job Reference"
      placeholder="Select Job Reference"
      controlName="jobReference"
      [form]="form"
      [selectedText]="field('jobReference').value"
    >
      <ng-container *ngFor="let jr of site.jobReferenceList">
        <ion-select-option [value]="jr">{{ jr }}</ion-select-option>
      </ng-container>
    </app-input-select-reactive>
  </ion-col>
</ng-template>

<!-- Contact Information Template -->
<ng-template #contactInformation>
  <ng-container *ngIf="field('site').value as site">
    <ion-col size="12">
      <app-title-block>Contact Information</app-title-block>
    </ion-col>
    <ng-container *ngTemplateOutlet="contactFields"></ng-container>
  </ng-container>
</ng-template>

<!-- Contact Fields Template -->
<ng-template #contactFields>
  <ion-col sizeMd="4" size="12">
    <app-input-reactive
      [form]="form"
      controlName="companyRepName"
      [optional]="true"
      title="Site Main Contact"
      [readonly]="shipment.status !== 'pending'"
    >
    </app-input-reactive>
  </ion-col>
  <ion-col sizeMd="4" size="12">
    <app-input-reactive
      [form]="form"
      controlName="companyRepEmail"
      [optional]="true"
      title="Email"
      [readonly]="shipment.status !== 'pending'"
    >
    </app-input-reactive>
  </ion-col>
  <ion-col sizeMd="4" size="12">
    <app-input-reactive
      [form]="form"
      controlName="companyRepContact"
      [optional]="true"
      title="Phone No."
      [readonly]="shipment.status !== 'pending'"
    >
    </app-input-reactive>
  </ion-col>
  <ion-col sizeMd="4" size="12">
    <app-input-reactive
      [form]="form"
      controlName="customerRepName"
      [optional]="true"
      title="Site Foreman"
      [readonly]="shipment.status !== 'pending'"
    >
    </app-input-reactive>
  </ion-col>
  <ion-col sizeMd="4" size="12">
    <app-input-reactive
      [form]="form"
      controlName="customerRepEmail"
      [optional]="true"
      title="Email"
      [readonly]="shipment.status !== 'pending'"
    >
    </app-input-reactive>
  </ion-col>
  <ion-col sizeMd="4" size="12">
    <app-input-reactive
      [form]="form"
      controlName="customerRepContact"
      [optional]="true"
      title="Phone No."
      [readonly]="shipment.status !== 'pending'"
    >
    </app-input-reactive>
  </ion-col>
</ng-template>

<!-- Delivery Information Template -->
<ng-template #deliveryInformation>
  <ion-col size="12">
    <app-title-block>Delivery Information</app-title-block>
  </ion-col>
  <ion-col size="6">
    <app-input-date
      [readonly]="shipment.status !== 'pending'"
      [form]="form"
      controlName="startDate"
      title="Hire Start Date"
    >
    </app-input-date>
  </ion-col>
  <ion-col size="6">
    <app-input-date
      [readonly]="shipment.status !== 'pending'"
      [form]="form"
      controlName="endDate"
      [min]="field('startDate').value"
      title="Expected Delivery Date"
    >
    </app-input-date>
  </ion-col>
  <ion-col size="12">
    <app-input-reactive
      title="Delivery Notes"
      controlName="notes"
      [form]="form"
      [textarea]="true"
      [readonly]="shipment.status !== 'pending'"
    >
    </app-input-reactive>
  </ion-col>
</ng-template>

<!-- Inventory Section Template -->
<ng-template #inventorySection>
  <ng-container *ngIf="isMobile">
    <ion-row>
      <ion-col size="6">
        <ion-text color="medium"><h4>Inventory Information</h4></ion-text>
      </ion-col>
      <ion-col size="6" class="text-end my-auto align-middle">
        <ion-text color="medium"><h6>Show all Items</h6></ion-text>
        <ion-toggle
          [checked]="viewAll === true || searching === true ? true : false"
          (ionChange)="viewAll = !viewAll"
        >
        </ion-toggle>
      </ion-col>
      <ion-col size="12">
        <ion-searchbar
          debounce="250"
          mode="ios"
          placeholder="Search by code, category or name"
          (ionChange)="search($event)"
        >
        </ion-searchbar>
      </ion-col>
      <ion-col size="12">
        <ng-container *ngTemplateOutlet="mobileInventoryList"></ng-container>
      </ion-col>
      <ng-container *ngTemplateOutlet="inventoryTotals"></ng-container>
    </ion-row>
  </ng-container>

  <ng-container *ngIf="!isMobile">
    <ion-row>
      <ion-col size="12">
        <ng-container *ngTemplateOutlet="desktopInventoryTable"></ng-container>
      </ion-col>
    </ion-row>
  </ng-container>
</ng-template>

<!-- Mobile Inventory List -->
<ng-template #mobileInventoryList>
  <ion-list class="card-outline">
    <ng-container *ngIf="items; else loadingMobileData">
      <ng-container *ngFor="let item of items; let i = index">
        <ng-container
          *ngTemplateOutlet="mobileInventoryItem; context: { item: item }"
        ></ng-container>
      </ng-container>
    </ng-container>
    <ng-template #loadingMobileData>
      <ion-item>
        <ion-label>
          <app-skeleton-text></app-skeleton-text>
          <app-skeleton-text></app-skeleton-text>
          <app-skeleton-text></app-skeleton-text>
        </ion-label>
      </ion-item>
    </ng-template>
  </ion-list>
</ng-template>

<!-- Mobile Inventory Item -->
<ng-template #mobileInventoryItem let-item="item">
  <ion-item
    color="light"
    [lines]="shipment.status !== 'pending' ? 'full' : 'none'"
    detail="false"
    button
    [hidden]="!(viewAll || (item.shipmentQty !== null && item.shipmentQty > 0))"
  >
    <ion-label>
      <div class="d-flex align-middle">
        <strong>{{ item.code }}</strong>
        <ion-badge color="primary" class="ms-auto text-xs">
          {{ item?.location || "No Location" }}
        </ion-badge>
        <ion-badge color="primary" class="ms-auto text-xs">
          {{ item?.supplier || "No Supplier" }}
        </ion-badge>
      </div>
      <div>
        <ion-text
          ><p class="text-wrap">{{ item.name }}</p></ion-text
        >
      </div>
      <div
        class="d-flex align-middle my-auto"
        *ngIf="shipment.status === 'pending'"
      >
        <p class="my-auto"><strong>Available Qty</strong></p>
        <ion-badge color="tertiary" class="ms-auto">
          {{ item.calculatedAvailableQty | number }}
        </ion-badge>
      </div>
      <div class="d-flex align-middle" *ngIf="item.shipmentQty > 0">
        <p><strong>Delivery Qty</strong></p>
        <ion-badge
          [color]="item.error ? 'danger' : 'success'"
          class="ms-auto mt-1"
        >
          {{ item.shipmentQty }}
        </ion-badge>
      </div>
    </ion-label>
  </ion-item>

  <ng-container *ngIf="shipment.status === 'pending'">
    <ion-note class="p-4" color="danger" *ngIf="item.error">
      <small>You cannot exceed available quantity</small>
    </ion-note>
    <ion-item
      lines="full"
      detail="false"
      button
      [hidden]="
        !(viewAll || (item.shipmentQty !== null && item.shipmentQty > 0))
      "
    >
      <ion-label slot="start">Delivery Quantity</ion-label>
      <ion-input
        class="text-end py-2"
        slot="end"
        inputmode="numeric"
        [color]="item.error ? 'danger' : 'success'"
        [value]="item.shipmentQty"
        (ionChange)="update($event, item)"
        (ionBlur)="autoSave()"
      >
      </ion-input>
    </ion-item>
  </ng-container>
</ng-template>

<!-- Desktop Inventory Table -->
<ng-template #desktopInventoryTable>
  <div class="table-responsive">
    <table class="table table-sm table-bordered">
      <thead>
        <tr>
          <th scope="col">Code</th>
          <th scope="col">Category</th>
          <th scope="col">Size</th>
          <th scope="col">Name</th>
          <th scope="col" class="text-center">Location</th>
          <th
            scope="col"
            class="text-center"
            *ngIf="shipment.status === 'pending'"
          >
            Available Qty
          </th>
          <th scope="col" class="text-center">Delivery Qty</th>
          <th scope="col" class="text-center">
            Weight ({{ company.mass.symbol }})
          </th>
          <th scope="col" class="text-center">Item Checked</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let item of items; let i = index">
          <ng-container
            *ngTemplateOutlet="desktopInventoryRow; context: { item: item }"
          ></ng-container>
        </ng-container>
      </tbody>
    </table>
  </div>
</ng-template>

<!-- Desktop Inventory Row -->
<ng-template #desktopInventoryRow let-item="item">
  <tr
    class="align-middle"
    *ngIf="viewAll || (item.shipmentQty !== null && item.shipmentQty >= 0)"
  >
    <th scope="row">{{ item.code }}</th>
    <td>{{ item.category }}</td>
    <td>{{ item.size }}</td>
    <td>{{ item.name }}</td>
    <td class="text-center">{{ item?.location }}</td>
    <td class="text-center" *ngIf="shipment.status === 'pending'">
      {{ item | calculate | number }}
    </td>
    <td class="text-center">
      <ion-input
        #qty
        debounce="300"
        inputmode="numeric"
        [color]="item.error ? 'danger' : 'success'"
        [clearOnEdit]="true"
        [value]="item.shipmentQty"
        (ionChange)="update($event, item)"
        (ionBlur)="autoSave()"
        [readonly]="shipment.status !== 'pending'"
      >
      </ion-input>
      <ion-label color="danger" *ngIf="item.error">
        you cannot exceed the available qty
      </ion-label>
    </td>
    <td class="text-end">
      {{ item.shipmentQty * item.weight | number }}
    </td>
    <td class="text-center">
      <ion-checkbox
        mode="ios"
        [checked]="item.checked"
        (ionChange)="checkItem($event, item)"
        [disabled]="shipment.status === 'sent'"
      >
      </ion-checkbox>
    </td>
  </tr>
</ng-template>

<!-- Inventory Totals -->
<ng-template #inventoryTotals>
  <ion-col size="12">
    <ion-item>
      <ion-label>Total Items</ion-label>
      <ion-label slot="end">
        {{ shipment.items ? shipment.items.length : 0 }}
      </ion-label>
    </ion-item>
    <ion-item>
      <ion-label>Total weight</ion-label>
      <ion-label slot="end">
        {{ shipment.items ? (shipment.items | weight : true) : [] }}
      </ion-label>
    </ion-item>
  </ion-col>
</ng-template>

<!-- Uploads Section Template -->
<ng-template #uploadsSection>
  <ion-col size="12">
    <app-multiuploader
      [autoupload]="true"
      (uploaded)="setUploads($event)"
    ></app-multiuploader>
  </ion-col>
  <ion-col size="12" *ngIf="shipment?.uploads?.length > 0">
    <app-title-block>Uploaded Files</app-title-block>
  </ion-col>
  <ion-col
    [attr.sizeXl]="isMobile ? null : '2'"
    [attr.sizeLg]="isMobile ? null : '3'"
    [attr.sizeMd]="isMobile ? null : '4'"
    [attr.size]="isMobile ? '6' : '6'"
    *ngFor="let file of shipment.uploads; let i = index"
  >
    <app-file-item
      [file]="file"
      [allowDelete]="!isMobile"
      (deleted)="removeUpload(i)"
    >
    </app-file-item>
  </ion-col>
</ng-template>

<!-- Signatures Section Template -->
<ng-template #signaturesSection>
  <ion-col
    class="mt-3"
    size="12"
    *ngIf="
      (shipment?.signedBy || shipment?.signedBy2) &&
      (shipment.status === 'on-route' || shipment.status === 'received')
    "
  >
    <app-title-block>Signatures</app-title-block>
    <table class="table table-bordered mb-3">
      <tbody>
        <tr class="align-middle">
          <td>Sent By</td>
          <td class="text-center">
            <ion-text slot="end">{{ shipment?.signedBy }}</ion-text>
          </td>
        </tr>
        <tr class="align-middle">
          <td>Signature</td>
          <td class="text-center">
            <img [src]="shipment?.signature" />
          </td>
        </tr>
        <tr class="align-middle">
          <td>Received By</td>
          <td class="text-center">
            <ion-text slot="end">{{ shipment?.signedBy2 }}</ion-text>
          </td>
        </tr>
        <tr class="align-middle">
          <td>Signature</td>
          <td class="text-center">
            <img [src]="shipment?.signature2" />
          </td>
        </tr>
      </tbody>
    </table>
  </ion-col>
</ng-template>

<!-- Signature Pad Template -->
<ng-template #signaturePad>
  <ion-col
    size="12"
    *ngIf="shipment.status === 'on-route' || shipment.status === 'pending'"
  >
    <app-title-block>Signature</app-title-block>
    <app-signature-pad
      #signature
      [showSave]="blob ? false : true"
      (res)="sign($event)"
    >
    </app-signature-pad>
  </ion-col>
</ng-template>

<!-- Footer Template -->
<ng-template #footer>
  <ion-footer
    mode="md"
    *ngIf="
      shipment.status !== 'void' &&
      shipment.status !== 'sent' &&
      shipment.status !== 'received'
    "
  >
    <ng-container *ngIf="isMobile && !items">
      <!-- Mobile totals in footer for mobile view only when not showing items in main content -->
      <ng-container *ngTemplateOutlet="inventoryTotals"></ng-container>
    </ng-container>
    <ng-container *ngIf="!isMobile">
      <!-- Desktop totals in footer -->
      <ng-container *ngTemplateOutlet="inventoryTotals"></ng-container>
    </ng-container>
    <ion-toolbar
      *ngIf="
        user.permissionsList.includes('Inventory Admin') ||
        user.permissionsList.includes('Super Admin')
      "
    >
      <ion-progress-bar type="indeterminate" *ngIf="loading"></ion-progress-bar>
      <ng-container *ngTemplateOutlet="footerButtons"></ng-container>
    </ion-toolbar>
  </ion-footer>
</ng-template>

<!-- Footer Buttons Template -->
<ng-template #footerButtons>
  <ion-buttons slot="start">
    <ion-button
      *ngIf="isEdit && !loading"
      (click)="updateShipment('void')"
      class="text-capitalize"
      fill="solid"
      shape="round"
      color="danger"
    >
      Void
    </ion-button>
    <ion-button
      *ngIf="isEdit && !loading && shipment.status === 'pending'"
      (click)="updateShipment('reserved')"
      class="text-capitalize"
      fill="solid"
      shape="round"
      color="tertiary"
    >
      Reserve
    </ion-button>
  </ion-buttons>
  <ion-buttons slot="end">
    <ion-button
      *ngIf="isEdit && !loading && shipment.status === 'reserved'"
      (click)="updateShipment('pending')"
      ]
      class="text-capitalize"
      shape="round"
      fill="solid"
      color="warning"
    >
      Unreserve
    </ion-button>
    <ion-button
      *ngIf="!isEdit && !loading"
      (click)="createShipment()"
      class="text-capitalize"
      shape="round"
      color="success"
      fill="solid"
    >
      Create
    </ion-button>
    <ion-button
      *ngIf="
        isEdit && !loading && ['pending', 'picklist'].includes(shipment.status)
      "
      (click)="updateShipment('pending')"
      class="text-capitalize"
      shape="round"
      color="warning"
      fill="solid"
    >
      Update
    </ion-button>
    <!-- <ion-button
      shape="round"
      *ngIf="isEdit && !loading && shipment.status === 'pending'"
      color="success"
      [disabled]="
        (!isMobile && (!blob || !shipment.signedBy)) ||
        (isMobile && (!blob || (!shipment.signedBy && form.invalid)))
      "
      (click)="sendDelivery()"
    >
      Send Delivery
    </ion-button>
    <ion-button
      shape="round"
      *ngIf="isEdit && !loading && shipment.status === 'on-route'"
      color="success"
      [disabled]="
        (!isMobile && (!blob || !shipment.signedBy2)) ||
        (isMobile && (!blob || (!shipment.signedBy2 && form.invalid)))
      "
      (click)="receiveDelivery()"
    >
      Receive Delivery
    </ion-button> -->
    <ion-button
      *ngIf="isEdit && !loading && shipment.status === 'pending'"
      [disabled]="!blob || !shipment.signedBy || form.invalid"
      (click)="receiveDelivery(true)"
      class="text-capitalize"
      shape="round"
      fill="solid"
      color="success"
    >
      Send
    </ion-button>
  </ion-buttons>
</ng-template>
