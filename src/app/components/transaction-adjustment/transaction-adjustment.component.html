<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="close()">
        <ion-icon
          slot="icon-only"
          name="arrow-back-outline"
          color="primary"
        ></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ !isEdit ? "Add Adjustment" : "Edit Adjustment" }} </ion-title>
    <ion-buttons slot="end">
      <ion-chip
        (click)="downloadPicklist()"
        mode="ios"
        shape="round"
        size="small"
        color="primary"
      >
        Picklist
      </ion-chip>
      <ion-chip
        *ngIf="isEdit && adjustmentDoc.status !== 'void'"
        (click)="downloadPdf()"
        mode="ios"
        shape="round"
        size="small"
        color="tertiary"
      >
        Return Note
      </ion-chip>
    </ion-buttons>
  </ion-toolbar>
</ion-header>
<ion-content class="ion-padding">
  <form [formGroup]="form" *ngIf="form">
    <ion-grid>
      <ion-row class="card-outline mb-3">
        <ion-col size="12">
          <ion-text color="medium">
            <h4>Return From</h4>
          </ion-text>
        </ion-col>
        <ion-col size="12" *ngIf="!isEdit">
          <ng-container *ngIf="sites$ | async as sites">
            <app-searchable-select
              (click)="select.open()"
              title="Select Site"
              [data]="sites"
              itemTextField="name"
              itemTextField2="customer.name"
              itemTextField3="code"
              [add]="false"
              (selectedChanged)="changeSite($event)"
              #select
            ></app-searchable-select>
          </ng-container>
        </ion-col>
        <ion-col *ngIf="field('site').value as site">
          <app-input-text
            *ngIf="isEdit"
            title="Site Address"
            [value]="site.name"
            [readonly]="true"
          >
          </app-input-text>
          <app-input-text
            title="Site Code"
            [value]="site.code"
            [readonly]="true"
          >
          </app-input-text>
          <app-input-text
            title="Customer Name"
            [value]="site.customer.name"
            [readonly]="true"
          >
          </app-input-text>
          <app-input-text
            title="Site Address"
            value="{{ site.address }} , {{ site.suburb }} , {{ site.city }}, {{
              site.zip
            }}, {{ site.country }}"
            [readonly]="true"
          >
          </app-input-text>
        </ion-col>
      </ion-row>
      <ion-row *ngIf="field('site').value">
        <ion-col size="12">
          <ion-text color="medium">
            <h4>Return Information</h4>
          </ion-text>
        </ion-col>
        <ion-col size="12">
          <app-input-reactive
            title="Returned By"
            controlName="createdByName"
            [form]="form"
            [readonly]="true"
          ></app-input-reactive>
        </ion-col>
        <ion-col size="12">
          <app-input-date
            [form]="form"
            controlName="returnDate"
            title="Return Date"
            [readonly]="adjustmentDoc.status !== 'submitted'"
          ></app-input-date>
        </ion-col>
        <ion-col size="12">
          <app-input-select-reactive
            title="Job Reference"
            placeholder="Select Job Reference"
            controlName="jobReference"
            [form]="form"
            [selectedText]="field('jobReference').value"
            (ionChange)="getTransactions($event)"
          >
            <ng-container
              *ngFor="let jr of field('site').value.jobReferenceList"
            >
              <ion-select-option [value]="jr">{{ jr }}</ion-select-option>
            </ng-container>
          </app-input-select-reactive>
        </ion-col>
        <ion-col size="12">
          <app-input-reactive
            title="Notes"
            controlName="notes"
            [form]="form"
            [textarea]="true"
            [readonly]="adjustmentDoc.status !== 'submitted'"
          >
          </app-input-reactive>
        </ion-col>
        <ng-container>
          <ion-col size="12">
            <ion-text color="medium">
              <h4>Driver Information</h4>
            </ion-text>
          </ion-col>
          <ion-col size="12" sizeMd="4">
            <app-input-reactive
              title="Driver Name"
              controlName="driverName"
              [form]="form"
              [readonly]="adjustmentDoc.status !== 'submitted'"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col size="12" sizeMd="4">
            <app-input-reactive
              title="Driver Phone No"
              controlName="driverNo"
              [form]="form"
              [readonly]="adjustmentDoc.status !== 'submitted'"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col size="12" sizeMd="4">
            <app-input-reactive
              title="Vehicle Registration"
              controlName="vehicleReg"
              [form]="form"
              [readonly]="adjustmentDoc.status !== 'submitted'"
            >
            </app-input-reactive>
          </ion-col>
        </ng-container>
        <ng-container *ngIf="field('jobReference').value">
          <ion-col size="6">
            <ion-text color="medium">
              <h4>Inventory Information</h4>
            </ion-text>
          </ion-col>
          <ion-col size="6" class="text-end my-auto align-middle">
            <ion-text color="medium"> <h6>Show all Items</h6> </ion-text>
            <ion-toggle
              [checked]="viewAll === true || searching === true ? true : false"
              (ionChange)="viewAll = !viewAll"
            ></ion-toggle>
          </ion-col>
          <ion-col size="12">
            <div class="d-flex">
              <ion-searchbar
                debounce="250"
                mode="ios"
                placeholder="Search by code, category or name"
                (ionChange)="search($event)"
              >
              </ion-searchbar>
              <ion-button
                class="my-auto"
                size="small"
                shape="round"
                color="tertiary"
                *ngIf="!loading && adjustmentDoc.status === 'submitted'"
                (click)="returnAll()"
                >Return all items</ion-button
              >
            </div>
          </ion-col>
          <ion-col size="12">
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th scope="col">Code</th>
                    <th scope="col">Category</th>
                    <th scope="col">Name</th>
                    <th scope="col" class="text-center">Location</th>
                    <th scope="col" class="text-center">Site Qty</th>
                    <th scope="col" class="text-center">Return Qty</th>
                    <!-- <th scope="col" class="text-center">
                    Weight ({{ company.mass.symbol }})
                  </th> -->
                    <ng-container
                      *ngIf="
                        adjustmentDoc.status !== 'void' &&
                        (adjustmentDoc.status === 'collected' ||
                          user.permissionsList.includes('Inventory Admin') ||
                          adjustmentDoc.status === 'received')
                      "
                    >
                      <th scope="col" class="text-center">Maintenance Qty</th>
                      <th scope="col" class="text-center">Damaged Qty</th>
                      <th scope="col" class="text-center">Lost Qty</th>
                    </ng-container>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngFor="let item of items; let i = index">
                    <tr class="align-middle" *ngIf="viewAll; else viewShipment">
                      <th scope="row">{{ item.code }}</th>
                      <td>{{ item.category }}</td>
                      <td>{{ item.name }}</td>
                      <td class="text-center">{{ item?.location }}</td>
                      <td class="text-center">
                        {{ item.balanceQty }}
                      </td>
                      <td class="text-center">
                        <ion-input
                          #qty
                          debounce="200"
                          type="number"
                          [color]="item.error ? 'danger' : 'success'"
                          [clearOnEdit]="true"
                          [value]="item.returnQty"
                          (ionChange)="update($event, item, 'returnQty')"
                          [readonly]="adjustmentDoc.status !== 'submitted'"
                        >
                        </ion-input>
                        <ion-label color="danger" *ngIf="item.error">
                          you cannot exceed the available qty
                        </ion-label>
                      </td>
                      <ng-container
                        *ngIf="
                          adjustmentDoc.status !== 'void' &&
                          (adjustmentDoc.status === 'collected' ||
                            user.permissionsList.includes('Inventory Admin') ||
                            adjustmentDoc.status === 'received')
                        "
                      >
                        <td class="text-center">
                          <ion-input
                            #MaintenanceQty
                            debounce="200"
                            type="number"
                            [color]="item.error ? 'danger' : 'primary'"
                            [clearOnEdit]="true"
                            [value]="item.inMaintenanceQty"
                            (ionChange)="update($event, item, 'maintenance')"
                            [readonly]="adjustmentDoc.status === 'received'"
                          >
                          </ion-input>
                          <ion-label color="danger" *ngIf="item.error">
                            you cannot exceed the return qty
                          </ion-label>
                        </td>
                        <td class="text-center">
                          <ion-input
                            #DamagedQty
                            debounce="200"
                            type="number"
                            [color]="item.error ? 'danger' : 'warning'"
                            [clearOnEdit]="true"
                            [value]="item.damagedQty"
                            (ionChange)="update($event, item, 'damaged')"
                            [readonly]="adjustmentDoc.status === 'received'"
                          >
                          </ion-input>
                          <ion-label color="danger" *ngIf="item.error">
                            you cannot exceed the return qty
                          </ion-label>
                        </td>
                        <td class="text-center">
                          <ion-input
                            #LostQty
                            debounce="200"
                            type="number"
                            [color]="item.error ? 'danger' : 'danger'"
                            [clearOnEdit]="true"
                            [value]="item.lostQty"
                            (ionChange)="update($event, item, 'lost')"
                            [readonly]="adjustmentDoc.status === 'received'"
                          >
                          </ion-input>
                          <ion-label color="danger" *ngIf="item.error">
                            you cannot exceed the return qty
                          </ion-label>
                        </td>
                      </ng-container>
                    </tr>
                    <ng-template #viewShipment>
                      <tr class="align-middle" *ngIf="item.returnQty > 0">
                        <th scope="row">{{ item.code }}</th>
                        <td>{{ item.category }}</td>
                        <td>{{ item.name }}</td>
                        <td class="text-center">{{ item?.location }}</td>
                        <td class="text-center">{{ item.balanceQty }}</td>
                        <td class="text-center">
                          <ion-input
                            #qty
                            debounce="200"
                            type="number"
                            [color]="item.error ? 'danger' : 'success'"
                            [clearOnEdit]="true"
                            [value]="item.returnQty"
                            (ionChange)="update($event, item, 'returnQty')"
                            [readonly]="adjustmentDoc.status !== 'submitted'"
                          >
                          </ion-input>
                          <ion-label color="danger" *ngIf="item.error">
                            you cannot exceed the available qty
                          </ion-label>
                        </td>

                        <ng-container
                          *ngIf="
                            adjustmentDoc.status !== 'void' &&
                            (adjustmentDoc.status === 'collected' ||
                              user.permissionsList.includes(
                                'Inventory Admin'
                              ) ||
                              adjustmentDoc.status === 'received')
                          "
                        >
                          <td class="text-center">
                            <ion-input
                              #MaintenanceQty
                              debounce="200"
                              type="number"
                              [color]="item.error ? 'danger' : 'primary'"
                              [clearOnEdit]="true"
                              [value]="item.inMaintenanceQty"
                              (ionChange)="update($event, item, 'maintenance')"
                              [readonly]="adjustmentDoc.status === 'received'"
                            >
                            </ion-input>
                            <ion-label color="danger" *ngIf="item.error">
                              you cannot exceed the return qty
                            </ion-label>
                          </td>
                          <td class="text-center">
                            <ion-input
                              #DamagedQty
                              debounce="200"
                              type="number"
                              [color]="item.error ? 'danger' : 'warning'"
                              [clearOnEdit]="true"
                              [value]="item.damagedQty"
                              (ionChange)="update($event, item, 'damaged')"
                              [readonly]="adjustmentDoc.status === 'received'"
                            >
                            </ion-input>
                            <ion-label color="danger" *ngIf="item.error">
                              you cannot exceed the return qty
                            </ion-label>
                          </td>
                          <td class="text-center">
                            <ion-input
                              #LostQty
                              debounce="200"
                              type="number"
                              [color]="item.error ? 'danger' : 'danger'"
                              [clearOnEdit]="true"
                              [value]="item.lostQty"
                              (ionChange)="update($event, item, 'lost')"
                              [readonly]="adjustmentDoc.status === 'received'"
                            >
                            </ion-input>
                            <ion-label color="danger" *ngIf="item.error">
                              you cannot exceed the return qty
                            </ion-label>
                          </td>
                        </ng-container>
                      </tr></ng-template
                    >
                  </ng-container>
                </tbody>
              </table>
            </div>
            <ion-item>
              <ion-label>Total Items</ion-label>
              <ion-label slot="end">
                {{ adjustmentDoc.items ? adjustmentDoc.items.length : 0 }}
              </ion-label>
            </ion-item>
            <!-- <ion-item>
              <ion-label>Total weight</ion-label>
              <ion-label slot="end">
                {{ adjustmentDoc.items ? (adjustmentDoc.items | weight : true) : [] }}
              </ion-label>
            </ion-item> -->
          </ion-col>
          <ion-col
            size="12"
            *ngIf="
              adjustmentDoc.status !== 'sent' &&
              adjustmentDoc.status !== 'void' &&
              adjustmentDoc.status !== 'received'
            "
          >
            <app-multiuploader></app-multiuploader>
          </ion-col>
          <ion-col size="12">
            <app-title-block> Uploaded Files </app-title-block>
            <ion-row>
              <ion-col
                sizeXl="2"
                sizeLg="3"
                sizeMd="4"
                size="6"
                *ngFor="let file of adjustmentDoc.uploads; let i = index"
              >
                <app-file-item
                  [file]="file"
                  [allowDelete]="false"
                ></app-file-item>
              </ion-col>
            </ion-row>
          </ion-col>
          <ion-col
            class="mt-3"
            size="12"
            *ngIf="
              (adjustmentDoc?.signedBy || adjustmentDoc?.signedBy2) &&
              (adjustmentDoc.status === 'collected' ||
                adjustmentDoc.status === 'received')
            "
          >
            <app-title-block> Signatures </app-title-block>

            <table class="table table-bordered mb-3">
              <tbody>
                <tr class="align-middle">
                  <td>Signed By</td>
                  <td class="text-center">
                    <ion-text slot="end">{{
                      adjustmentDoc?.signedBy
                    }}</ion-text>
                  </td>
                </tr>
                <tr class="align-middle">
                  <td>Signature</td>
                  <td class="text-center">
                    <img [src]="adjustmentDoc?.signature" />
                  </td>
                </tr>
                <tr class="align-middle">
                  <td>Signed By</td>
                  <td class="text-center">
                    <ion-text slot="end">{{
                      adjustmentDoc?.signedBy2
                    }}</ion-text>
                  </td>
                </tr>
                <tr class="align-middle">
                  <td>Signature</td>
                  <td class="text-center">
                    <img [src]="adjustmentDoc?.signature2" />
                  </td>
                </tr>
              </tbody>
            </table>
          </ion-col>
          <ion-col
            size="12"
            *ngIf="
              adjustmentDoc.status === 'on-route' ||
              adjustmentDoc.status === 'collected' ||
              (isEdit &&
                adjustmentDoc.status !== 'submitted' &&
                adjustmentDoc.status !== 'received' &&
                adjustmentDoc.status !== 'void')
            "
          >
            <app-title-block> Signature </app-title-block>
            <app-signature-pad
              #signature
              [showSave]="blob ? false : true"
              (res)="sign($event)"
            ></app-signature-pad>
          </ion-col>
          <ion-col size="12" *ngIf="loading">
            <ion-progress-bar type="indeterminate"></ion-progress-bar>
          </ion-col>
        </ng-container>
      </ion-row>
      <ion-row
        class="mt-5"
        *ngIf="
          adjustmentDoc.status !== 'void' &&
          adjustmentDoc.status !== 'sent' &&
          adjustmentDoc.status !== 'received'
        "
      >
        <ion-col size="1">
          <ion-button
            shape="round"
            *ngIf="isEdit && !loading"
            color="danger"
            [disabled]="form.invalid"
            (click)="updateReturn('void')"
            >Void Return</ion-button
          >
        </ion-col>
        <ion-col size="11" class="text-end">
          <ion-button
            shape="round"
            [disabled]="form.invalid"
            *ngIf="!isEdit && !loading"
            (click)="createReturn()"
            >Create Return</ion-button
          >
          <ion-button
            shape="round"
            *ngIf="isEdit && !loading && adjustmentDoc.status === 'submitted'"
            [disabled]="form.invalid"
            (click)="updateReturn('submitted')"
            >Update Return</ion-button
          >

          <ion-button
            shape="round"
            *ngIf="isEdit && adjustmentDoc.status === 'submitted' && !loading"
            color="success"
            [disabled]="form.invalid || error"
            (click)="updateReturn('on-route', true)"
            >Schedule Collection</ion-button
          >

          <ion-button
            shape="round"
            *ngIf="isEdit && !loading && adjustmentDoc.status === 'on-route'"
            color="success"
            (click)="logCollection()"
            [disabled]="!blob || !adjustmentDoc.signedBy"
            >Return Collected</ion-button
          >

          <ion-button
            shape="round"
            *ngIf="isEdit && !loading && adjustmentDoc.status === 'collected'"
            color="success"
            [disabled]="!blob || !adjustmentDoc.signedBy2"
            (click)="approveReturn()"
            >Approve Return</ion-button
          >
          <ng-container
            *ngIf="
              user.permissionsList.includes('Inventory Admin') &&
              adjustmentDoc.status === 'submitted'
            "
          >
            <ion-button
              shape="round"
              fill="outline"
              *ngIf="isEdit && !loading"
              color="tertiary"
              (click)="approveReturn(true)"
              >Approve Immediately</ion-button
            >
          </ng-container>
        </ion-col>
      </ion-row>
    </ion-grid>
  </form>
</ion-content>
